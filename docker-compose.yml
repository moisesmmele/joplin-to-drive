version: '3.8'

services:
  joplin-sync:
    build: .
    container_name: joplin_sync
    restart: unless-stopped
    # Run as root to allow the entrypoint to fix cron permissions, 
    # then the cron job itself drops down to 'appuser'
    user: root
    volumes:
      # 1. Scripts (Logic)
      - ./scripts/joplin-export.sh:/scripts/joplin-export.sh:ro
      - ./scripts/joplin-cron:/scripts/joplin-cron:ro

      # 2. Configs (State)
      # We mount rclone.conf as read-write so rclone can update tokens
      - ./config/rclone.conf:/root/.config/rclone/rclone.conf
      # Persist Joplin's local database so we don't re-download everything every time
      - joplin_data:/home/appuser/.config/joplin

    environment:
      - JOPLIN_SERVER_URL=${JOPLIN_SERVER_URL}
      - JOPLIN_SERVER_EMAIL=${JOPLIN_SERVER_EMAIL}
      - JOPLIN_SERVER_PASSWORD=${JOPLIN_SERVER_PASSWORD}
      - RCLONE_REMOTE_NAME=gdrive
      - RCLONE_DEST_PATH=JoplinNotes

volumes:
  joplin_data:
